<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Local Services Finder</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>

    <style>
    :root {
        --primary: #0066cc;
        --secondary: #f4f7f6;
        --text-dark: #333;
        --white: #ffffff;
        --accent: #ff9900;
    }

    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        margin: 0;
        background-color: var(--secondary);
        color: var(--text-dark);
    }

    header {
        background: var(--white);
        padding: 1rem 2rem;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: sticky;
        top: 0;
        z-index: 100;
    }

    header h1 { color: var(--primary); margin: 0; }

    nav a {
        text-decoration: none;
        color: var(--text-dark);
        margin-left: 20px;
        font-weight: 500;
    }

    nav a:hover { color: var(--primary); }

    .hero {
        background: linear-gradient(135deg, #0066cc 0%, #004c99 100%);
        color: white;
        text-align: center;
        padding: 4rem 1rem;
        margin-bottom: 2rem;
    }

    .search-box {
        background: white;
        display: inline-flex;
        padding: 10px;
        border-radius: 50px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        margin-top: 20px;
        flex-wrap: wrap;
        justify-content: center;
    }

    .search-box select, .search-box button {
        padding: 10px 20px;
        border: none;
        font-size: 1rem;
        background: transparent;
    }

    .search-box button {
        cursor: pointer;
        font-weight: bold;
    }

    .search-box button:last-child {
        background-color: var(--accent);
        color: white;
        border-radius: 30px;
        margin-left: 10px;
    }

    .container {
        display: flex;
        height: calc(100vh - 70px);
    }

    .list-view {
        width: 35%;
        background: white;
        overflow-y: auto;
        padding: 20px;
        border-right: 1px solid #ccc;
    }

    .map-view {
        width: 65%;
    }

    #map {
        width: 100%;
        height: 100%;
    }

    .card {
        background: white;
        border: 1px solid #eee;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
        transition: 0.2s;
        cursor: pointer;
    }

    .card:hover {
        transform: translateY(-2px);
        border-color: var(--primary);
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }

    .card.selected {
        border-color: var(--accent);
        box-shadow: 0 0 0 2px rgba(255,153,0,0.2);
    }

    .badge {
        background-color: var(--accent);
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 0.8rem;
        color: white;
    }

    .card button {
        width: 100%;
        padding: 10px;
        border: none;
        margin-top: 10px;
        border-radius: 5px;
        background-color: var(--primary);
        color: white;
        cursor: pointer;
    }

    .card button:hover { background-color: #00386b; }

    @media (max-width: 768px) {
        .container { flex-direction: column-reverse; }
        .list-view { width: 100%; height: 50%; }
        .map-view { width: 100%; height: 50%; }
        .search-box { flex-direction: column; border-radius: 12px; }
        .search-box button:last-child { width: 100%; margin: 10px 0 0 0; }
    }
    </style>
</head>

<body>

<header>
    <h1>Local Services Finder</h1>
    <nav>
        <a href="#">Home</a>
        <a href="#">How it works</a>
        <a href="#">For Providers</a>
        <a href="#">Contact</a>
    </nav>
</header>

<section class="hero">
    <h2>Find trusted local services near you</h2>
    <p>Select filters below and view best professionals nearby</p>

    <div class="search-box">
        <select id="serviceSelect">
            <option value="">Service type</option>
            <option value="Electrician">Electrician</option>
            <option value="Plumber">Plumber</option>
            <option value="Driver">Driver</option>
            <option value="Carpenter">Carpenter</option>
        </select>

        <select id="distanceSelect">
            <option value="">Distance</option>
            <option value="2">Within 2 km</option>
            <option value="5">Within 5 km</option>
            <option value="10">Within 10 km</option>
        </select>

        <select id="budgetSelect">
            <option value="">Budget</option>
            <option value="low">₹200 – ₹500</option>
            <option value="medium">₹500 – ₹1000</option>
            <option value="high">₹1000+</option>
        </select>

        <button id="searchBtn">Search</button>
    </div>
</section>

<main class="container">
    <section class="list-view">
        <h3>Available Providers</h3>
        <div id="providersList"></div>
    </section>
    <section class="map-view">
        <div id="map"></div>
    </section>
</main>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
let map;
let markersLayer;
const providerMarkers = {};

function initMap() {
  map = L.map('map').setView([12.9716, 77.5946], 13); // Bangalore

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  markersLayer = L.layerGroup().addTo(map);
}

function renderList(providers) {
  const container = document.getElementById('providersList');
  container.innerHTML = '';

  if (!providers.length) {
    container.innerHTML = '<p>No providers found.</p>';
    return;
  }

  providers.forEach(p => {
    const card = document.createElement('div');
    card.className = 'card';
    card.dataset.id = p.id;

    card.innerHTML = `
      <h4>${p.name} ${p.rating >= 4.8 ? '<span class="badge">Top Rated</span>' : ''}</h4>
      <p>${p.service} • ${p.rating} ★ (${p.reviews} reviews)</p>
      <p>Distance: ${p.distanceKm} km • ETA: ${p.etaMinutes} mins</p>
      <p>Starting at <strong>₹${p.priceFrom} / ${p.priceUnit}</strong></p>
      <button>Book Now</button>
    `;

    container.appendChild(card);
  });

  addCardEvents();
}

function renderMarkers(providers) {
  markersLayer.clearLayers();
  Object.keys(providerMarkers).forEach(id => delete providerMarkers[id]);

  providers.forEach(p => {
    const marker = L.marker([p.lat, p.lng]);
    marker.bindPopup(`<strong>${p.name}</strong><br>${p.service}<br>⭐ ${p.rating} (${p.reviews} reviews)`);
    markersLayer.addLayer(marker);
    providerMarkers[p.id] = marker;
  });

  if (providers.length > 0) {
    const group = new L.featureGroup(providers.map(p => L.marker([p.lat, p.lng])));
    map.fitBounds(group.getBounds().pad(0.3));
  }
}

function addCardEvents() {
  document.querySelectorAll('.card').forEach(card => {
    card.addEventListener('click', () => {
      const id = Number(card.dataset.id);
      document.querySelectorAll('.card').forEach(c => c.classList.remove('selected'));
      card.classList.add('selected');

      const marker = providerMarkers[id];
      if (marker) {
        map.setView(marker.getLatLng(), 15, { animate: true });
        marker.openPopup();
      }
    });
  });
}

async function loadProviders() {
  const params = new URLSearchParams();
  const svc = document.getElementById('serviceSelect').value;
  const dist = document.getElementById('distanceSelect').value;
  const bud = document.getElementById('budgetSelect').value;

  if (svc) params.append('service', svc);
  if (dist) params.append('maxDistanceKm', dist);
  if (bud) params.append('budget', bud);

  const res = await fetch('/api/providers?' + params.toString());
  const data = await res.json();

  renderList(data);
  renderMarkers(data);
}

document.addEventListener('DOMContentLoaded', () => {
  initMap();
  loadProviders();
  document.getElementById('searchBtn').addEventListener('click', loadProviders);
});
</script>

</body>
</html>